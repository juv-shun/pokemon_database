# 本番環境へのデータ投入手順

このドキュメントでは、生成したCSVファイルをSupabaseの本番環境に投入する手順を説明します。

## 前提条件

- CSVファイルが `output/` ディレクトリに生成済みであること
- Supabase本番プロジェクトが作成済みであること
- マイグレーションが本番環境に適用済みであること
- `psql` コマンドがインストールされていること

## 1. 環境変数の設定

### 1.1 .envファイルの作成

`.env.example` をコピーして `.env` ファイルを作成します：

```bash
cp .env.example .env
```

### 1.2 Supabase接続情報の取得

Supabaseダッシュボードから接続情報を取得します：

1. Supabaseプロジェクトのダッシュボードにアクセス
2. `Project Settings` > `Database` を開く
3. `Connection String` セクションの **Session pooler** タブを選択
4. 以下の情報を確認：
   - **Project Ref**: 接続文字列の `postgres.` の後ろの部分（例: `vphcabhyqxdljkyijccc`）
   - **Password**: データベースパスワード

### 1.3 .envファイルの編集

`.env` ファイルを開き、取得した接続情報を設定します：

```bash
# Supabase Database接続情報（Session Pooler使用）
SUPABASE_PROJECT_REF=vphcabhyqxdljkyijccc
SUPABASE_DB_PASSWORD=your_actual_password_here
```

**重要**:
- `SUPABASE_PROJECT_REF` にはプロジェクトRefを設定してください
- パスワードは実際の値に置き換えてください
- Session Poolerのホスト（`aws-1-ap-northeast-1.pooler.supabase.com`）はスクリプト内でデフォルト設定されています

## 2. マイグレーションの適用

本番環境にスキーマを作成するため、マイグレーションを適用します：

```bash
# Supabaseプロジェクトにリンク（初回のみ）
supabase link --project-ref your-project-ref

# マイグレーションを本番環境にプッシュ
supabase db push
```

## 3. データ投入の実行

### 3.1 接続テスト

まず、Session Pooler経由で接続できることを確認します：

```bash
# .envファイルを読み込んで接続テスト
source .env
PGPASSWORD="$SUPABASE_DB_PASSWORD" psql -h "aws-1-ap-northeast-1.pooler.supabase.com" -p 5432 -U "postgres.${SUPABASE_PROJECT_REF}" -d postgres -c "SELECT version();"
```

PostgreSQLのバージョン情報が表示されれば接続成功です。

### 3.2 投入スクリプトの実行

本番環境にデータを投入します：

```bash
./scripts/import_to_supabase.sh --remote
```

または

```bash
./scripts/import_to_supabase.sh --production
```

### 3.3 確認プロンプト

スクリプトは以下の確認を行います：

1. **最終確認**: 本番環境への投入の確認
   - `yes` と入力して続行

2. **データクリア確認**: 既存データをクリアするかの確認
   - `yes` と入力してクリア実行
   - それ以外でスキップ

## 4. 投入後の確認

### 4.1 データ件数の確認

スクリプトは自動的に以下を表示します：

- 各テーブルのレコード数
- 外部キー制約の整合性チェック結果

### 4.2 Supabase Studioでの確認

ブラウザでSupabase Studioを開き、以下を確認：

1. Table Editorでデータが正しく投入されているか
2. 各テーブルのレコード数が想定通りか
3. リレーションが正しく設定されているか

### 4.3 SQLでの確認

```sql
-- 各テーブルの件数確認
SELECT 'abilities' as table_name, COUNT(*) FROM sv.abilities
UNION ALL
SELECT 'moves', COUNT(*) FROM sv.moves
UNION ALL
SELECT 'pokemon', COUNT(*) FROM sv.pokemon
UNION ALL
SELECT 'pokemon_abilities', COUNT(*) FROM sv.pokemon_abilities
UNION ALL
SELECT 'pokemon_moves', COUNT(*) FROM sv.pokemon_moves;

-- サンプルデータの確認
SELECT p.name_ja, p.type_primary, p.type_secondary
FROM sv.pokemon p
ORDER BY p.pokedex_no
LIMIT 10;
```

## 5. トラブルシューティング

### 接続エラー

```
[ERROR] 本番Supabase環境に接続できません
```

**対処法**:
- `.env` ファイルの接続情報を確認
- SupabaseダッシュボードでIPホワイトリストを確認
- データベースのポーリング設定を確認

### マイグレーションエラー

```
Error: relation "sv.pokemon" does not exist
```

**対処法**:
- マイグレーションが適用されているか確認: `supabase db pull`
- 必要に応じて再度マイグレーションを適用: `supabase db push`

### 外部キー制約エラー

```
ERROR: insert or update on table violates foreign key constraint
```

**対処法**:
- CSVファイルのID整合性を確認
- 投入順序が正しいか確認（マスタテーブル → 関連テーブル）

## 6. ローカル環境での動作確認

本番投入前に、ローカル環境で動作確認することを推奨します：

```bash
# ローカル環境を起動
supabase start

# ローカル環境に投入
./scripts/import_to_supabase.sh

# または明示的に --local を指定
./scripts/import_to_supabase.sh --local
```

## 7. セキュリティ上の注意

- `.env` ファイルは **絶対にGitにコミットしない**（`.gitignore` に登録済み）
- データベースパスワードは厳重に管理する
- 本番環境への投入は慎重に行う
- 可能であれば、まずステージング環境でテストする

## 8. コマンドリファレンス

```bash
# ローカル環境に投入
./scripts/import_to_supabase.sh
./scripts/import_to_supabase.sh --local

# 本番環境に投入
./scripts/import_to_supabase.sh --remote
./scripts/import_to_supabase.sh --production
```
